<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title></title>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
 <!--[if lte IE 8]>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
 <![endif]-->
  <!-- Добавляем ссылку на JS-скрипт библиотеки -->
 <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
<script type="text/javascript" src="client/jquery-3.3.1.min.js"></script>
 <style>

#map-wrapper {
    width: 100%;
    height: 500px;
    position: relative;
    border: 1px solid black;
}

#map {
    width: 100%;
    height: 920px;
    background-color: green;
}

#button-wrapper {
    position: absolute;
    width: 100px;
    height: 600px;
    top: 70px; 
    left: 1px; 
    background: #f0f0f0; 
    border: 1px solid black;
}
 
 </style>
 
</head>

<body>



<div class="span9" style="height:100%">
    <div id="map-wrapper">
        <div id="map"></div>
        <div id="button-wrapper">
	<script>
	$.post("http://www.testsite.loc/SMOT/server/main.php",{"name":"getRoutes"},
   		function(data){
  			var routes = $.parseJSON(data);
			for (var route in routes) {	
			var btn = document.createElement('input');
			btn.id = 'route' + route.toString();
			btn.type = 'button'
			btn.value = routes[route][0].toString() + " " +routes[route][1].toString() ;
			btn.setAttribute('onclick', 'obj.HandleClick1();');
			document.body.appendChild(btn);
			//console.log (btn.id);
		}
	});

</script>
            <input type="button" id="Btn1" value="Троллейбус 1" onclick="" class="btnStyle span3" />
            <input type="button" id="Btn2" value="Троллейбус 2" onclick="" class="btnStyle span3" /> 
            <input type="button" id="Btn3" value="Троллейбус 3" onclick="" class="btnStyle span3" />        
        </div> 
    </div>
    </div>

<script type='text/javascript'>
	//Определяем карту, координаты центра и начальный масштаб
	var map = L.map('map').setView([61.77,34.40], 14);

	//Добавляем на карту слой OpenStreetMap
	L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
	}).addTo(map);
	var loc1, loc2;
	map.on('click', function(e) {
    	    onMapClick(e);
	});
	function onMapClick(e) {
		if (loc1 == null) {
         	   loc1 = new L.marker(e.latlng, {draggable: 'true'});
         	   loc1.on('dragend', function(event) {

			sendPost();
		   });
                   map.addLayer(loc1);
	           }
	        else if (loc2 == null) {
            loc2 = new L.marker(e.latlng, {draggable: 'true'});
            loc2.on('dragend', function(event) {
		sendPost();
            });
            map.addLayer(loc2);
	    sendPost();
        }
	};

	$.post("http://www.testsite.loc/SMOT/server/main.php",{"name":"getStops"},
   		function(data){
     		var stops = $.parseJSON(data);
		//console.log(stops);
		for (var prop in stops) {
 		// console.log(prop + " : " + stops[prop]);
			var posLat = parseFloat(stops[prop][0].toString());
			var posLng = parseFloat(stops[prop][1].toString());
			L.marker([posLat, posLng]).addTo(map);
		}
	});
	var polyline;
	var next_point=0;
	function sendPost() {
        	if (loc2 != null && loc1 != null) {
           		var p1 = loc1.getLatLng(), p2 = loc2.getLatLng();
 
			$.post("http://www.testsite.loc/SMOT/server/main.php",{"name":"getPaths", 					"point1_lat":parseFloat(p1.lat.toString()), 
				"point1_lon":parseFloat(p1.lng.toString()),
				"point2_lat":parseFloat(p2.lat.toString()), 
				"point2_lon":parseFloat(p2.lng.toString())}, 
				function(data){
					if (polyline) {
                        			map.removeLayer(polyline);
              				}
					var stops = $.parseJSON(data);
					for (var prop in stops) {
						for (var list in stops[prop].listPoints) {
							//console.log (stops[prop].listPoints[list].latitude);
                    					console.log(prop + ":" + parseFloat(stops[prop].listPoints[list].latitude.toString()));
							console.log(prop + ":" + parseFloat(stops[prop].listPoints[list].longitude.toString()));
							var lat = parseFloat(stops[prop].listPoints[list].latitude.toString()),
							    lon = parseFloat(stops[prop].listPoints[list].longitude.toString());
							var ll= {lat,lon};

							//if(next_point == 0)
							//next_point = {lat,lon};
							//L.polyline([next_point, ll]).addTo(map).bindPopup("." + ll);
							//next_point = ll;
						}
					}
		
				}
			);
       		}
    	}

</script>

</body>
</html>
